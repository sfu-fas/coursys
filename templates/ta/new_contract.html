{% extends "base.html" %}
{% load course_display form_display %}

{% block title %}New TA Contract {% endblock %}
{% block h1 %}New TA Contract {% endblock %}

{% block subbreadcrumbs %}
<li>&gt; <a href="{% url ta.views.all_contracts %}">TA Contracts</a></li>
<li>&gt; New</li>
{% endblock %}

{% block headextra %}
<script type="text/javascript">
//<![CDATA[
	function calculate(){
		var total = 0;
		for(var i = 0; i < 3; i++){
			val = parseFloat($('#id_tacourse_set-' + i + '-bu').val())
			if(val > 0)
				total += val
		}
		$('#total_bu').val(total)   
		var salary_rate = parseFloat($('#salary_per_bu').val())
		var schol_rate = parseFloat($('#schol_per_bu').val())
		var bu = parseFloat($('#total_bu').val())
		var salary_sem = (bu * salary_rate).toFixed(2)
		var schol_sem = (bu * schol_rate).toFixed(2)
		$('#salary_sem').val(salary_sem)
		$('#schol_sem').val(schol_sem)
		var salary_bi = (salary_sem / "{{posting.payperiods}}").toFixed(2)
		var schol_bi = (schol_sem / "{{posting.payperiods}}").toFixed(2)
		$('#salary_bi').val(salary_bi)
		$('#schol_bi').val(schol_bi)
	}
	
	function validate(cat){
		$('#messages').hide()
		if($('#messages ul.errorlist').html!='')
			$('#messages ul.errorlist').html("")
		var valid = true
		var html = ""
		
		if(cat){
			if($('#id_appt_category').val()=="" && $('#messages ul').html()!=""){
				html += '<li class="warning">Please select an appointment type</li>'
				valid = false
			}
		}
		var clist = new Array()
		$('.course_select').each(function(){
			if($(this).val()!="")
				clist.push($(this).val())
		})	

		if(!check_dup(clist.sort())){
			html += '<li class="warning">Duplicate course selection</li>'
			valid = false
		}
			
    	if(html!=""){
    		$('#messages ul.warninglist').html(html)
    		$('#messages').show()
    	}
    	return valid;
	}
	
	function check_dup(list){
		for(var i = 0; i< list.length-1; i++){
			if(list[i]==list[i+1])
				return false
		}
		return true
	}
		
    $(document).ready(function() {
    	$("#id_pay_start").datepicker({'dateFormat': 'yy-mm-dd'});
    	$("#id_pay_end").datepicker({'dateFormat': 'yy-mm-dd'});
    	$("#id_deadline").datepicker({'dateFormat': 'yy-mm-dd'});
    	if(!('{{formset.non_form_errors}}'))
    		$('#messages').hide()
    	else
    		$('.errorlist li').attr('class','error')
 		
		$(".course_select").change(function(){
			if(!validate(false))
				return
			var cid = $(this).val()
			var bu_inp = '#' + this.id.replace('-course','-bu')
			if(cid != ''){//nonempty selection
				$.post("{% url ta.views.new_contract post_slug=posting.slug %}",
				{'csrfmiddlewaretoken': "{{csrf_token}}", 'course': cid},
				function(data){
					$(bu_inp).val(data)
				})
			}
			else
				$(bu_inp).val(0)
    	})
    	    	
    	//setting rates per bu based on appt category
    	//if previously selected, wipe and enforce reselect/resend ajax to avoid NaN values
    	if($('#salary_sem').val()=="")
    		$('#id_appt_category').val("")
    		
    	$('#id_appt_category').change(function(){
    		var cat = $(this).val()
    		if(cat!=''){
    			$.post("{% url ta.views.new_contract post_slug=posting.slug %}",
  				{'csrfmiddlewaretoken': "{{csrf_token}}", 'appt_cat': cat},
  				function(data){
    				$('#salary_per_bu').val(data.split(',')[0])
    				$('#schol_per_bu').val(data.split(',')[1])
    				if($('#salary_bi').val()!="")
   			 			calculate()
   			 	}); 
    		}  			 
    	})
    	
    	//calcuate event
    	$('#button_cal').click(function(){
    		if(validate(true))
    			calculate()
    	})
    });
    
//]]>
</script>
{% endblock %}

{% block content %}

<div class="table_container">
	<table class="info">
        <tbody>
	    <tr>
	    	<th class="ui-state-default">Semester</th>
            <td>{{ posting.semester }}</td>
        </tr>
	    <tr>
            <th class="ui-state-default">Unit</th>
            <td>{{ posting.unit }}</td>
        </tr>
	    <tr>
            <th class="ui-state-default">Open Date</th>
            <td>{{ posting.opens }}</td>
        </tr>
	    <tr>
            <th class="ui-state-default">Close Date</th>
            <td>{{ posting.closes }}</td>
        </tr>
        </tbody>
    </table>
</div>

<div id="form_container">
<form action="{% url ta.views.new_contract post_slug=posting.slug%}" method="post">{% csrf_token %}
<fieldset class="wide">
<legend>General Info</legend>
{{ form|as_dl }}
</fieldset>

<div class="container">
	<div id="messages">{{formset.non_form_errors}}<ul class="warninglist"></ul></div>
</div>

<fieldset>
<legend>Course and Payment Details</legend>
	<div class="table_container">
	  {{ formset.management_form }} 	
      <table class="display" id="ta_course">
      	<thead class="form_head">
          <tr>
         	<th scope="col">Course</th>
         	<th scope="col">Description</th>
         	<th scope="col">Base Unit</th>         
          </tr>         
        </thead>  
        <tbody>
		  {% for form in formset.forms %} 	      
		      {{ form|display_form_as_row:"deleted_flag" }}
	      {% endfor %}
	      <tr id="cal_tr">
	      	<td></td>
	      	<td class="table-row-label" id="total_bu_label" align="right">Total Base Units:&nbsp;</td>
	      	<td class="table-row-label"><input type"text" readonly="readonly" id="total_bu" value""></td>
	      </tr>
	      <tr id="cal_tr"><td colspan=3><button type="button" class="submit" id="button_cal">Calculate</button></td></tr>
        </tbody>
      </table>
   </div>
   
   <div class="table_container"> 
      <table class="info" id="ta_pay">
      	<thead class="form_head">
          <tr>
         	<th scope="col"></th>
         	<th scope="col">Pay Per BU</th>
         	<th scope="col">Biweekly Rate</th>
         	<th scope="col">Semester Rate</th>
          </tr>         
        </thead>  
        <tbody>
        	<tr> 
        		<th class="ui-state-default">Salary</th>
        		<td><input id="salary_per_bu" type="text" name="pay_per_bu" value="" /></td>
        		<td><input id="salary_bi" type=text readonly="readonly" value="" /></td>
        		<td><input id="salary_sem" type=text readonly="readonly" value="" /></td>
        	</tr>
        	<tr>
        		<th class="ui-state-default">Scholarship</th>
        		<td><input id="schol_per_bu" type="text" name="scholarship_per_bu" value=""/></td>
        		<td><input id="schol_bi" type=text readonly="readonly" value="" /></td>
        		<td><input id="schol_sem" type=text readonly="readonly" value="" /></td>
        	</tr>
        </tbody>
      </table>
   </div>
</fieldset>

<p><input id="submit" type="submit" class="submit" value="Submit" /></p>

</form>
</div>

{% endblock %}
