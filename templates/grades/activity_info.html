{% extends "grades/base.html" %}
{% load course_display %}

{% block title %}{{ activity.name }} Information{% endblock %}
{% block h1 %}{{ activity.name }} Information{% endblock %}

{% block grades_headextra %}
<script type="text/javascript">
//<![CDATA[
    function fetchUserId(data) {
	var dataArray = data.split('&')
	for (var i=0; i<dataArray.length; i++) {
	    pos = dataArray[i].indexOf('userid');
	    if (pos != -1) {
		userid = dataArray[i].substring(pos+7)
		return userid
	    }
	}
    }

    $(document).ready(function() {
	addLinkClickStyleClass('a.redbutton', 'redbutton_onclick');
	// activate dataTable ui
	oTable = $('#student_grades').dataTable({
                "bPaginate": false,
		"bJQueryUI": true,
		"sPaginationType": "full_numbers",
		"iDisplayLength" : 50,
		"aaSorting": [[0, "asc"]],
		"aoColumns": [
		    null,
		    null,
		    null,
		    { "sType": "by-nolink" },
		    {% if activity.group %}null,{% endif %}
		    { "sType": "by-nolinkmark" },
		    {% if not activity.calnumericactivity %}{ "sType": "by-nolinkmark" },null
		    {% else %}null{% endif %}
		]
	});
	
	{% if activity.calnumericactivity %}
	$(document).ajaxSend(function(e, xhr, settings) {
	    cal_link = $('#'+fetchUserId(settings.data));
	    ajax_status = cal_link.parent().children('.ajax_status')
	    if (ajax_status.html() != null) {
		ajax_status.text('Processing...');
	    }
	    else {
		cal_link.parent().append('<div class="ajax_status">Processing...</div>');
		ajax_status = cal_link.parent().children('.ajax_status');
	    }
	});
	$(document).ajaxSuccess(function(e, xhr, settings) {
	    cal_link = $('#'+fetchUserId(settings.data));
	    cal_link.parent().children('.ajax_status').remove();
	    cal_link.parent().children('span.grade').html(xhr.responseText);
	    cal_link.parent().parent().find('.grade_status').text('calculated');
	});
	$(document).ajaxError(function(e, xhr, settings) {
	    cal_link = $('#'+fetchUserId(settings.data));
	    cal_link.parent().children('.ajax_status').text(xhr.status + " " + xhr.statusText);
	});
	$('a.calculator').attr('href', 'javascript: return false;').click(function(){
	    cal_link = $(this);
	    /* post request */
	    $.post("{% url grades.views.calculate_individual_ajax course_slug=course.slug activity_slug=activity.slug %}",		  	 
		    {'userid': cal_link.attr('id')});
	});
	{% endif %}
    });
//]]></script>
{% endblock %}

{% block subbreadcrumbs %}<li>&gt; <a href="{{course.get_absolute_url}}">{{ course.name }}</a></li><li>&gt; {{ activity.name }}</li>{% endblock %}

{% block actions %}
<div id="actions">
    <h2 class="heading">Actions</h2>
    <ul>
	    {% if activity.group %}
		    {% ifequal activity_view_type 'group' %}
		    <li>
		    <a href="{% url grades.views.activity_info course_slug=course.slug, activity_slug=activity.slug%}">View By Student</a>
		    </li>
		    {% endifequal %}
		    {% ifequal activity_view_type 'individual' %}
		    <li>
		    <a href="{% url grades.views.activity_info_with_groups course_slug=course.slug, activity_slug=activity.slug%}">View By Group</a>
		    </li>
		    {% endifequal %}
	    {% endif %}
	    <li class="newsec"><a href="{% url grades.views.edit_activity course_slug=course.slug activity_slug=activity.slug %}?from_page={{ from_page }}">Edit Activity Details</a></li>
	    <li><a href="{% url submission.views.show_components course_slug=course.slug, activity_slug=activity.slug%}">Configure Submission</a></li>

	    <li class="newsec"><a href="{% url submission.views.download_activity_files course_slug=course.slug, activity_slug=activity.slug%}">Download Submissions</a></li>
	    <li><a href="{% url marking.views.manage_activity_components course_slug=course.slug,activity_slug=activity.slug%}">Configure Marking</a></li>
	    <li><a href="{% url marking.views.mark_all_students course_slug=course.slug, activity_slug=activity.slug%}">Mark all</a></li>
	    {% if activity.group %}
		    <li>
		    <a href="{% url marking.views.mark_all_groups course_slug=course.slug, activity_slug=activity.slug%}?from_page={{ from_page }}">Mark all by Group</a>
		    </li>
	    {% endif %}

	    <li class="newsec"><a href="{% url marking.views.export_csv course_slug=course.slug, activity_slug=activity.slug%}">Export Grades</a></li>
	    <li><a href="{% url grades.views.activity_stat course_slug=course.slug activity_slug=activity.slug %}">Display Statistics</a></li> 
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="table_container">
    <table class="info">
        <tbody>
	    <tr>
                <th class="ui-state-default">Activity Type</th>
                <td>{{ activity.type_long }}</td>
            </tr>
            <tr>
                <th class="ui-state-default">Name</th>
                <td>{{activity.name}}</td>
            </tr>
            <tr>
                <th class="ui-state-default">Short name</th>
                <td>{{activity.short_name}}</td>
            </tr>
            <tr>
                <th class="ui-state-default">Status</th>
                <td><form action="{% url grades.views.release_activity course_slug=course.slug, activity_slug=activity.slug %}" method="post">{% csrf_token %}<p>
                {{activity.get_status_display}}
                {% if activity.status == "INVI" %}
                <input type="submit" value="make visible" />
                {% else %}{% if activity.status == "URLS" %}
                <input type="submit" value="release grades" />
                {% endif %}{% endif %}</p></form></td>
            </tr>
            <tr>
                <th class="ui-state-default">Due date</th>
                <td class="{{activity.due_class}}">{{activity.due_date}}</td>
            </tr>
            <tr>
                <th class="ui-state-default">Percentage</th>
                <td>{{activity.percent}}</td>
            </tr>
			{% if activity.group %}
			<tr>
                <th class="ui-state-default">Group Activity</th>
                <td>Yes</td>
            </tr>
			{% endif %}
            {% if activity.numericactivity %}
            <tr>
                <th class="ui-state-default">Maximum grade</th>
                <td>{{activity.max_grade}}</td>
            </tr>
            {% endif %}
	    {% if activity.calnumericactivity %}
            <tr>
                <th class="ui-state-default">Formula</th>
                <td>{{activity.formula}}</td>
            </tr>
            {% endif %}
            {% if activity.url %}
            <tr>
                <th class="ui-state-default">More Information</th>
                <td>{{activity.url|urlize}}</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% block activity_info_grades_block %}
{% if activity.calnumericactivity %}
<div class="buttongroup">
    <a class="redbutton" href="{% url grades.views.calculate_all course_slug=course.slug activity_slug=activity.slug %}">Calculate all</a>
</div>
{% endif %}
<div class="datatable_container">
    <table class="display" id="student_grades">
        <thead>
            <tr>
                <th scope="col">Last name</th>
                <th scope="col">First name</th>
		<th scope="col">User ID</th>
		<th scope="col">Stu #</th>
		{% if activity.group %}<th scope="col">Group</th>{% endif %}
		<th scope="col">Grade</th>
		{% if not activity.calnumericactivity %}
		<th scope="col">Marking</th>
		<th scope="col">Submission</th>
		{% else %}
		<th scope="col">Calculate</th>
		{% endif %}
            </tr>
	</thead>
        <tbody>
	    {% for member in students %}
	    {% with member.person.userid as userid %}
	    {% with grades|hash:userid as grade %}
	    <tr>
		<td>{{ member.person.last_name }}</td>
		<td>{{ member.person.first_name }}</td>
		<td>{{ member.person.userid }}</td>
		<td><a href="{{member.get_absolute_url}}" title="student info">{{ member.person.emplid }}</a></td>

		{% if activity.group %}<td>{% with group_membership|hash:userid as group %}{% if group %}{{group}}{%else%}&mdash;{%endif%}{%endwith%}</td>{% endif %}
		<td>
		    {% if not grade or grade.flag == 'NOGR'%}
			<a href="{% url marking.views.change_grade_status course_slug=course.slug activity_slug=activity.slug userid=member.person.userid %}?from_page={{from_page}}" title="edit grade">&mdash;/{{activity.max_grade}}</a>		   
		    {% else %}
			<a href="{% url marking.views.change_grade_status course_slug=course.slug activity_slug=activity.slug userid=member.person.userid %}?from_page={{from_page}}" title="edit grade">{{ grade.display_staff }}</a>
		    {% endif %}
		    {% if activity.calnumericactivity %}
		      {% if not grade or grade.flag != 'CALC' %}
		      ({{ grade.get_flag_display }})
		      {% endif %}
		    {% else %}
		      {% if grade and grade.flag != 'GRAD' and grade.flag != 'NOGR' %}
		      ({{ grade.get_flag_display }})
		      {% endif %}
		    {% endif %}
		</td>
		{% if not activity.calnumericactivity %}
		<td>
		    marking link
		</td>
		<td>
		    {% if submitted|hash:userid %}<a href="{% url submission.views.show_student_submission_staff course_slug=course.slug activity_slug=activity.slug userid=member.person.userid %}"><img src="{{MEDIA_URL}}icons/magnifier.png" title="view details" alt="View" /></a>
		    <a href="{% url submission.views.download_file course_slug=course.slug activity_slug=activity.slug userid=member.person.userid %}"><img src="{{MEDIA_URL}}icons/page_compressed.png" title="download ZIP" alt="Download" /></a>{% endif %}
		</td>
		{% else %}
		<td>
		    recalculate link
		</td>
		{% endif %}
	    </tr>
	    {% endwith %}
	    {% endwith %}
	    {% empty %}
	    <tr>
		<td class="empty">No student</td>
		<td></td>
		<td></td>
		<td></td>
		<td></td>
		{% if activity.group %}<td></td>{% endif %}
		<td></td>
		<td></td>
		{% if not activity.calnumericactivity %}
		<td></td>
		{% endif %}
	    </tr>
	    {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
{% endblock %}
