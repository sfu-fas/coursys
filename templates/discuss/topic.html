{% extends "base.html" %}
{% block title %}{{ course.subject }} {{ course.number }} Discussion{% endblock %}
{% block headextra %}
<link rel="stylesheet" href="{{MEDIA_URL}}style/discuss.css" media="all" />
<script type="text/javascript">
	$(document).ready(function() {
		{% if not form.errors %}
			$("#discussion-topic-reply-form").hide();
		{% endif %}
		{% if form.errors %}
			$("#topic-reply-toggle").hide();
			$('html, body').animate({scrollTop: $("#discussion-topic-reply-form").offset().top});
			$("#id_content").focus();
		{% endif %}
		$("#topic-reply-toggle").click(function() {
			
			$("#topic-reply-toggle").hide();
			$("#discussion-topic-reply-form").show('slide');
			$('html, body').animate({scrollTop: $(document).height()});
			$("#id_content").focus();
		});
		$(".remove-discussion-reply").click(function() {
			topicPK = $(this).attr('id');
			var confirmRemove = confirm("Are you sure you want to remove this reply?");
			if (confirmRemove) {
				$("form#remove-reply-" + topicPK).submit();
			}
		});
	});
</script>
{% endblock %}

{% block h1 %}{{ course.subject }} {{ course.number }} Discussion{% endblock %}

{% block subbreadcrumbs %}
<li>
	&gt; <a href="{% url grades.views.course_info course_slug=course.slug %}">{{ course.name }}</a>
</li>
<li>
	&gt; <a href="{% url discuss.views.discussion_index course_slug=course.slug %}">Discussion</a>
</li>
<li>
	&gt; View Topic
</li>
{% endblock %}
{% block actions %}

{% if view == 'staff' or request.user.username == topic.author.person.userid and not topic.still_editable %}
<div id="actions">
	<h2 class="heading">Actions</h2>
	<ul>
		{% if request.user.username == topic.author.person.userid and not topic.still_editable %}
		<li>
		  	<a href="{% url discuss.views.edit_topic course_slug=course.slug topic_id=topic.pk %}">Edit Topic ({{ topic.editable_time_left }} left)</a>
		</li>
		{% endif %}
		{% if view == 'staff' %}
		<li>
			<a href="{% url discuss.views.change_topic_status course_slug=course.slug topic_id=topic.pk %}">Manage Topic</a>
		</li>
		{% endif %}
	</ul>
</div>
{% endif %}

{% endblock %}

{% block content %}

{% if topic.status == 'HID' %}
    <div id="topic-hidden-warning">
    	This topic is currently hidden
    </div>
{% endif %}

<div class="discussion-topic-body">
	<div class="discussion-topic-header">
		<span class="discussion-topic-header-title"> 
			{% if topic.pinned %} 
			<span style="color: #B5111B">[Pinned]</span> 
			{% endif %}
			{% if topic.status == 'ANS' %} 
			<span style="color: #1F6B08">[Answered]</span> 
			{% endif %}
			{{ topic.title }}
		</span>
		<div class="discussion-topic-meta">
			<span class="discussion-topic-author-content">{{ topic.author.person.name }} ({{ topic.author.person.userid }})</span>
			<span class="discussion-topic-last"><span style="color:#1F6B08">{{ topic.last_activity_at_delta }}</span></span>
		</div>
	</div>

	<div class="discussion-topic-content">
		{{ topic.html_content }}
	</div>
</div>

<div class="discussion-topic-replies-header">
	Replies:
</div>

<div class="discussion-topic-replies">
	{% if replies|length_is:0 and topic.status != 'CLO' %} 
	<div class="discussion-replies-warning">No replies yet...</div>
	{% endif %}
	{% if replies|length > 0 %}
	{% for reply in replies %}
		<div class="discussion-topic-reply">
			<div class="discussion-reply-author">
				{{ reply.author.person.name }} ({{reply.author.person.userid}}),
			</div>
			<div class="discussion-reply-time">
				{{ reply.create_at_delta }}
			</div>
			
			<div class="discussion-reply-controls">
			{% if view == 'staff' %}
			<form id="remove-reply-{{ reply.pk }}" action = "{% url discuss.views.remove_message course_slug=course.slug topic_id=topic.pk message_id=reply.pk%}" method="post">
				{% csrf_token %}
			</form>
			<span class="remove-discussion-reply" id="{{ reply.pk }}">Remove</span>
			{% endif %}
			</div>
			<div class="discussion-reply-content">
				{{ reply.html_content }}
			</div>
		</div>
	{% endfor %}
	{% endif %}
	{% if topic.status == 'CLO' and view == 'student' %}
	<div class="discussion-replies-warning">Replies are currently disabled for this topic...</div>
	{% endif %}
	{% if topic.status == 'CLO' and view == 'staff' %}
	<div class="discussion-replies-warning">Topic is closed. Students may not post replies.</div>
	{% endif %}
</div>

{% if topic.status != 'CLO' or view == 'staff' %}
<a href="#" id="topic-reply-toggle">Post a reply</a>
<div id="discussion-topic-reply-form">
	<form action="{% url discuss.views.view_topic course_slug=course.slug topic_id=topic.pk %}" method="post">
		{% csrf_token %}
		<div class="discussion-topic-reply-errors">
			{% for error in form.content.errors %}
			    <span>{{ error }}</span><br />
			{% endfor %}
		</div>
		{{ form.content }}
		<div><input type="submit" value="Reply" /></div>
	</form>
</div>
{% endif %}

{% endblock %}

