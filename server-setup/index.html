<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Course Management Server Config</title>
<style type="text/css">
h2 {
  margin-top: 2em;
}
dt {
  margin-top: 1em;
  font-weight: bold;
}
code.file {
  font-weight: bold;
}
</style>
</head>
<body>
<h1>Course Management Server Config</h1>

<p>This document describes the setup of the <code>courses.cs.sfu.ca</code> server as done in April/May 2011 by Greg Baker.</p>

<h2 id="base">Base System Setup</h2>
<dl>
<dt>Base system</dt>
  <dd>Ubuntu 10.04 Lucid LTS (as provided by CSTS).</dd>
<dt>Additional packages installed</dt>
  <dd>Like this:
  <blockquote><pre>dpkg --purge apache2.2-bin apache2.2-common apache2-utils apache2 apache2-mpm-worker apache2.2-common
apt-get install nginx python-flup subversion python-mysqldb mysql-client-5.1 python-tz memcached python-memcache stunnel4</pre></blockquote></dd>
<dt>Django Package</dt>
  <dd>System requires Django &ge;1.2, so newer package was downloaded separately from <a href="http://packages.ubuntu.com/search?keywords=python-django&amp;searchon=names&amp;suite=all&amp;section=all">Ubuntu package repository</a>.
  <blockquote><pre>dpkg -i python-django_1.2.3-1ubuntu0.2.10.10.2_all.deb</pre></blockquote>
  </dd>
<dt>Memcached</dt>
  <dd>In <code class="file">/etc/memcached.conf</code>, change the port to 22122.</dd>
<dt>Stunnel config for MySQL</dt>
  <dd>In <code class="file">/etc/default/stunnel4</code>, enable stunnel.  Add this to <code class="file">/etc/stunnel/stunnel.conf</code> and remove other services and <code>cert</code> line:
  <blockquote><pre>cert = /etc/stunnel/stunnel.pem

client = yes

[mysqls]
accept  = 127.0.0.1:4000
connect = onara.cs.sfu.ca:5000</pre></blockquote>
  <p>Copy the <code class="file">/etc/default/stunnel.pem</code> cretificate.</p>
  <blockquote><pre>chmod 0600 /etc/default/stunnel.pem</pre></blockquote>
  </dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
</dl>

<h2 id="nginx">NGINX Web Server</h2>
<dl>
<dt>Base Config Changes</dt>
  <dd>Commented out the <code>SCRIPT_NAME</code> line in <code class="file">/etc/nginx/fastcgi_params</code>.  Python/Django FastCGI apps fail without doing this.</dd>
<dt>SSL certificates</dt>
  <dd>The <code>.cs.sfu.ca</code> wildcard SSL certificates in <code class="file">/etc/nginx/cert.pem</code> and <code class="file">/etc/nginx/cert.key</code>.  Certificate installation checked with <a href="http://www.digicert.com/help/">Digicert Certificate Tester</a>.
  <blockquote><pre>chown root.root /etc/nginx/cert.*
chmod 0600 /etc/nginx/cert.*</pre></blockquote>
  <p>Note: <code class="file">.pem</code> and <code class="file">.cert</code> files are apparently the same thing: no need to convert.</p></dd>
<dt>Server Config</dt>
  <dd>Main configuration file for server setup, <code class="file">/etc/nginx/sites-enabled/default</code> restored from <a href="etc_nginx_sites-enabled_default">version on old server</a>.</dd>
<dt>Static Content</dt>
  <dd>Static content is searched for in <code class="file">~/static/</code> so create some appropriate symlinks there:
  <blockquote><pre>mkdir ~/static
cd ~/static
ln -s ../courses/media media
ln -s /usr/share/pyshared/django/contrib/admin/media adminmedia</pre></blockquote>
  </dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
</dl>

<h2 id="fastcgi">FastCGI Process</h2>
<dl>
<dt>Startup Script</dt>
  <dd>In <code class="file">~/fastcgi/</code>, put <a href="startfs.txt">the start/stop script <code class="file">startfs.sh</code></a>.
  <blockquote><pre>chmod 0755 ~/fastcgi/startfs.sh
chmod 0711 ~</pre>
  </blockquote>
  </dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
<dt></dt>
  <dd></dd>
</dl>

<h2 id="app">Actual Application</h2>
<dl>
<dt>Code</dt>
  <dd>Code checked out from Subversion repository:
  <blockquote><pre>svn co https://cs-svn.cs.sfu.ca/svn/courseman/trunk/courses /home/ggbaker/courses</pre></blockquote>
  <p>But somebody following these instructions: <strong>check the Subversion URL</strong>!  Stable tags are created when serious development is going on&mdash;that might be the right one to use.</p>
  </dd>
<dt>Data Importer</dt>
  <dd>
  <p>Create a file <code class="file">~/dbpass</code> with two lines: (1) password for course management data view, (2) password for TA database.  This file is read by the importer (to avoid having those passwords in the Subversion repo).</p>
  </dd>
<dt>Crontab</dt>
  <dd>
  <blockquote><pre>30 4 * * * cd /home/ggbaker/courses/ && python coredata/importer.py &lt; /home/ggbaker/dbpass
30 * * * * nice ionice -c 3 /home/ggbaker/bin/courses-backup</pre></blockquote>
  <p>This requires <a href="courses-backup">my backup script, <code class="file">courses-backup</code></a>.</p>
  </dd>
<dt>DB dumps</dt>
  <dd><blockquote><pre>mysqldump --user=courseuser --password="<var>DBPASS</var>" --port=4000 --host=127.0.0.1 --skip-extended-insert course_management \
   | grep -v "INSERT INTO \`django_session\`" | grep -v "^-- Dump completed on"</pre></blockquote></dd>
<dt>App startup</dt>
  <dd>Add this to <code class="file">/etc/rc.local</code>:
  <blockquote><pre>/home/ggbaker/fastcgi/startfs.sh</pre></blockquote>
  </dd>
<dt>Submitted Files</dt>
  <dd>Submitted files from old server were copied to new server (at <code class="file">/data/submitted_files/</code>). New location must match <code>SUBMISSION_PATH</code> in <code class="file">settings.py</code>.</dd>
</dl>

</body>
</html>


